var app={audio:new Audio,timeKeepingAudio:new Audio,isAudioPlaying:!1,mapbox:null,lngLat:[0,0],markers:[],route:[],userMarker:null,timeKeepingTimer:null,init:function(o){app.config={geolocationSettings:{enableHighAccuracy:!1,maximumAge:0,timeout:2e4},markersUrl:"/data/markers.geojson",routeUrl:"/data/route.geojson",mapboxUrl:"mapbox://styles/lukesturgeon/cjlrt20fu8i3z2spjnowdy5ae",audioDistance:13,timeKeeping:6e4},$.extend(app.config,o),app.setup()},setup:function(){console.log("hmcro v 3.1r1"),app.goto(),Modernizr.audio&&$("#audioSupported").hide(),Modernizr.geolocation&&$("#geolocationSupported").hide(),$('a[href="#requirements"]').click(function(){app.goto("#requirements")}),$('a[href="#map"]').click(function(){navigator.geolocation.getCurrentPosition(app.onGeolocationSuccess,app.onGeolocationError,app.config.geolocationSettings),app.goto("#map"),app.playAudio("1_Welcome",!0)}),$('a[href="#welcome"]').click(function(){app.goto("#welcome")}),$('a[href="#privacy"]').click(function(){app.goto("#privacy")}),app.audio.addEventListener("timeupdate",app.onAudioUpdate),app.audio.addEventListener("ended",app.onAudioStopped),app.audio.addEventListener("pause",app.onAudioStopped),app.audio.addEventListener("play",app.onAudioStarted),$.ajax({dataType:"json",url:app.config.markersUrl,success:app.onMarkersLoaded})},goto:function(o){$("#js-error").hide(),$("#welcome").hide(),$("#requirements").hide(),$("#map").hide(),$("#privacy").hide(),$(o).show()},onMarkersLoaded:function(o){console.log("onMarkersLoaded"),o.features.forEach(function(o){app.markers.push({lngLat:[o.geometry.coordinates[0],o.geometry.coordinates[1]],mp3:o.properties.mp3})}),$.ajax({dataType:"json",url:app.config.routeUrl,success:app.onRouteLoaded})},onRouteLoaded:function(o){console.log("onRouteLoaded"),o.features.forEach(function(o){app.route.push({lngLat:[o.geometry.coordinates[0],o.geometry.coordinates[1]],mp3:o.properties.mp3})}),app.goto("#welcome")},setupMapbox:function(){console.log("setupMapbox"),mapboxgl.accessToken="pk.eyJ1IjoibHVrZXN0dXJnZW9uIiwiYSI6ImNpazcwenlzYjAwenZpZm0yZGVtOXpzNGoifQ.qBHqidaLVWQtIEu09uhSkg",app.mapbox=new mapboxgl.Map({container:"mapbox",style:app.config.mapboxUrl,center:app.lngLat,zoom:17.1}),app.mapbox.on("load",function(){$("#map .loading-img").hide(),app.route.forEach(function(o){var a=document.createElement("div");a.className="route",new mapboxgl.Marker(a).setLngLat(o.lngLat).addTo(app.mapbox)}),app.markers.forEach(function(o){var a=document.createElement("div");a.className="marker",new mapboxgl.Marker(a).setLngLat(o.lngLat).addTo(app.mapbox)});var o=document.createElement("div");o.className="user",app.userMarker=new mapboxgl.Marker(o).setLngLat(app.lngLat).addTo(app.mapbox),navigator.geolocation.watchPosition(app.onGeolocationSuccess,app.onGeolocationError,app.geolocationSettings)})},onGeolocationSuccess:function(o){app.lngLat[0]=o.coords.longitude,app.lngLat[1]=o.coords.latitude,console.log(app.lngLat),app.mapbox?(app.userMarker&&app.userMarker.setLngLat(app.lngLat),app.mapbox.panTo(app.lngLat),app.findMarkerToPlay(),app.findRouteToPlay()):app.setupMapbox()},onGeolocationError:function(o){1==o.code?alert("Location access is denied. Use your phone's settings to enable."):(console.warn("ERROR("+o.code+"): "+o.message),alert(o.message))},findMarkerToPlay:function(){for(var o=app.markers.length-1;o>=0;o--){var a=app.markers[o],e=turf.point(app.lngLat),p=turf.point(a.lngLat);Math.floor(1e3*turf.distance(e,p))<=app.config.audioDistance&&(app.playAudio(a.mp3),app.markers.splice(o,1),alert("play "+a.mp3))}},findRouteToPlay:function(){for(var o=app.route.length-1;o>=0;o--){var a=app.route[o],e=turf.point(app.lngLat),p=turf.point(a.lngLat);Math.floor(1e3*turf.distance(e,p))<=app.config.audioDistance&&(app.playAudio(a.mp3,!0),app.route.splice(o,1),alert("play "+a.mp3))}},playAudio:function(o,a){a?(console.log("[hidden] playAudio"),app.audio.pause(),app.timeKeepingAudio.src="/audio/"+o+".mp3",app.timeKeepingAudio.play()):(console.log("playAudio: "+o),app.audio.src="/audio/"+o+".mp3",app.audio.play(),app.timeKeepingAudio.pause(),$("#player .audio-title").text(o+".mp3"))},onAudioUpdate:function(){var o=Math.floor(app.audio.currentTime),a=Math.floor(app.audio.duration),e=Math.floor(o/a*100);$("#player .audio-bar").css({width:e+"%"})},onAudioStarted:function(){app.isAudioPlaying=!0,console.log("onAudioStarted"),clearInterval(app.timeKeepingTimer),$("#player .audio-bar").css({width:"0%"}),$("#player").show()},onAudioStopped:function(){app.isAudioPlaying=!1,console.log("onAudioStopped"),$("#player").hide(),timeKeepingTimer=setInterval(app.onTimeKeeping,2e4)},onTimeKeeping:function(){var o=Math.floor(6.9*Math.random());app.playAudio("TimeKeeping_"+o,!0)}};$(document).ready(app.init);