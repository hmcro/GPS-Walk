var app=new Vue({el:"#app",data:{state:"welcome",geolocationSettings:{enableHighAccuracy:!1,maximumAge:0,timeout:2e4},geolocationId:null,map:null,userMarker:null,audio:new Audio,audioName:"",currentTime:0,totalTime:0,isPlaying:!1},created:function(){console.log("hmcro v 3.0r2"),window.addEventListener("hashchange",this.hashChanged),this.audio.addEventListener("timeupdate",this.onAudioUpdate),this.audio.addEventListener("ended",this.onAudioStopped),this.audio.addEventListener("pause",this.onAudioStopped),this.audio.addEventListener("play",this.onAudioStarted);var o=this,t=new XMLHttpRequest;t.overrideMimeType("application/json"),t.open("GET","https://raw.githubusercontent.com/hmcro/Maps/master/test-n20sx.geojson",!0),t.onreadystatechange=function(){4==t.readyState&&"200"==t.status&&(o.markers=JSON.parse(t.responseText))},t.send(null)},methods:{onHashChanged:function(o){console.log(o)},goto:function(o){"map"!=o||this.map||this.initGeolocation(),this.state=o},link:function(o){location.href=o},initGeolocation:function(){navigator.geolocation.getCurrentPosition(this.onGeolocationSuccess,this.onGeolocationError,this.geolocationSettings)},onGeolocationSuccess:function(o){if(this.latitude=o.coords.latitude,this.longitude=o.coords.longitude,console.log(this.longitude,this.latitude),this.map){this.userMarker&&this.userMarker.setLngLat([this.longitude,this.latitude]),this.map.panTo([this.longitude,this.latitude]);var t=this;this.markers.features.forEach(function(o){var e=turf.point([t.longitude,t.latitude]),i=turf.point([o.geometry.coordinates[0],o.geometry.coordinates[1]]);Math.floor(1e3*turf.distance(e,i))<=20&&(t.playAudio(o.properties.mp3),alert("play "+o.properties.mp3))})}else this.initMap(),this.playAudio("1_Welcome")},onGeolocationError:function(o){1==o.code?alert("Location access is denied. Use your phone's settings to enable."):(console.warn("ERROR("+o.code+"): "+o.message),alert(o.message))},initMap:function(){console.log("map init"),console.log(this),mapboxgl.accessToken="pk.eyJ1IjoibHVrZXN0dXJnZW9uIiwiYSI6ImNpazcwenlzYjAwenZpZm0yZGVtOXpzNGoifQ.qBHqidaLVWQtIEu09uhSkg",this.map=new mapboxgl.Map({container:"map",style:"mapbox://styles/lukesturgeon/cjlrt20fu8i3z2spjnowdy5ae",center:[this.longitude,this.latitude],zoom:17.1});var o=this;this.map.on("load",function(){o.markers.features.forEach(function(t){var e=document.createElement("div");e.className="marker",new mapboxgl.Marker(e).setLngLat(t.geometry.coordinates).addTo(o.map)});var t=document.createElement("div");t.className="user",o.userMarker=new mapboxgl.Marker(t).setLngLat([o.longitude,o.latitude]).addTo(o.map),o.geolocationId=navigator.geolocation.watchPosition(o.onGeolocationSuccess,o.onGeolocationError,o.geolocationSettings)})},playAudio:function(o){console.log("playAudio: "+o),this.audioName=o,this.audio.src="/audio/"+o+".mp3",this.audio.play()},toggleAudio:function(){this.isPlaying?this.audio.pause():this.audio.play()},onAudioUpdate:function(){this.currentTime=Math.floor(this.audio.currentTime),this.totalTime=Math.floor(this.audio.duration)},onAudioStarted:function(){console.log("onAudioStarted"),console.log(this),this.isPlaying=!0},onAudioStopped:function(){this.isPlaying=!1,console.log("onAudioStopped")}},computed:{progress:function(){return Math.floor(this.currentTime/this.totalTime*100)},jsSupported:function(){return!0},audioSupported:function(){return Modernizr.audio},geolocationSupported:function(){return Modernizr.geolocation}}});